<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Chat room | Revel - A Web Application Framework for Go!</title>
<link rel="icon" href="/img/favicon.ico" type="image/x-icon" /> 
<link rel="shortcut icon" href="/img/favicon.png" type="image/png" />

<link href="/pages-revel/js/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">
<link href="/pages-revel/js/bootstrap-3.3.7-dist/css/bootstrap-theme.min.css" rel="stylesheet">
<link href="/pages-revel/css/jekyll-github.css" rel="stylesheet">

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="/pages-revel/js/bootstrap-3.3.7-dist/js/bootstrap.min.js" type="text/javascript"></script>


<link href="/pages-revel/css/revel.17.css" rel="stylesheet">

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-35042202-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


</head>

<body>
    
    

    
<nav class="navbar navbar-inverse ">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <div id="main-logo"><a ddclass="navbar-brand" href="/">Revel</a>
            </div>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                                
                <li >
                    <a href="/pages-revel/tutorial/index.html"><span class="glyphicon glyphicon-education" aria-hidden="true"></span> Tutorial</a></li>
                
                <li >
                    <a href="/pages-revel/manual/index.html"><span class="glyphicon glyphicon-book" aria-hidden="true"></span> Manual</a></li>
                    
                <li >
                    <a href="/pages-revel/modules/index.html"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> Modules</a></li>
                    
                    
                <li class="active">
                    <a href="/pages-revel/examples/index.html"><span class="glyphicon glyphicon-sound-stereo" aria-hidden="true"></span> Examples</a></li>
                
                <li >
                    <a href="/pages-revel/quickref/index.html"><span class="glyphicon glyphicon-screenshot" aria-hidden="true"></span> Quick Ref</a></li>
                    
                    
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Project <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="https://github.com/revel/" target="github"><span class="glyphicon glyphicon-object-align-horizontal" aria-hidden="true"></span> Revel project @ github</a></li>
                        <li class="divider"></li>
                        <li class="dropdown-header">Revel</li>
                            <li><a href="https://godoc.org/github.com/revel/revel" target="godoc"><span class="glyphicon glyphicon-hand-right" aria-hidden="true"></span> godoc</a></li>
                            <li><a href="https://github.com/revel/revel" target="github"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Source code</a></li>
                            <li><a href="https://github.com/revel/revel/issues" starget="github"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> Issues</a></li>
                        <li class="divider"></li>
                        <li class="dropdown-header">Revel command</li>
                            <li><a href="https://github.com/revel/cmd" target="github"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Source code</a></li>
                            <li><a href="https://github.com/revel/cmd/issues" target="github"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> Issues</a></li>
                        <li class="divider"></li>
                        <li class="dropdown-header">Modules</li>
                        <li><a href="https://github.com/revel/modules" target="github"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Source code</a></li>
                        <li class="divider"></li>
                        <li class="dropdown-header">Example Apps</li>
                        <li><a href="https://github.com/revel/examples" target="github"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Source code</a></li>
                        <li class="divider"></li>
                        <li class="dropdown-header">revel.github.io</li>
                        <li><a href="https://github.com/revel/revel.github.io" target="github"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Source code</a></li>
                        <li><a href="https://github.com/revel/revel.github.io/issues" starget="github"><span class="glyphicon glyphicon-th-list" aria-hidden="true"></span> Issues</a></li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Support <span class="caret"></span></a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="https://gitter.im/revel/community" target="_blank">Chat on gitter.im</a></li>
                        <li><a href="http://stackoverflow.com/questions/tagged/revel" target="_blank">Revel at StackOverflow</a></li>
                    </ul>
                <li>
                 
            </ul>
        </div>
    </div>
</nav>


    <div class="container revel-examples">
        <div class="row">
            <div class="col-md-3">
                <div class="leftnav">
    <ul class="nav">
        
            <li class="nav-header">Examples</li>
            
                
                
                    <li><a href="index.html">Overview</a></li>
                
            
                
                
                    <li><a href="booking.html">Booking</a></li>
                
            
                
                
                    <li class="active"><a href="chat.html">Chat</a></li>
                
            
                
                
                    <li><a href="validation.html">Validation</a></li>
                
            
                
                
                    <li><a href="upload.html">Upload</a></li>
                
            
                
                
                    <li><a href="twitter-oauth.html">Twitter OAuth</a></li>
                
            
                
                
                    <li><a href="facebook-oauth2.html">Facebook OAuth2</a></li>
                
            
                
                
                    <li><a href="messages.html">Messages</a></li>
                
            
        
    </ul>
</div>

            </div>

            <div class="col-md-9">
                <div class="page-header">
                    <a href="https://github.com/revel/revel.github.io/edit/master/examples/chat.md" class="improve-page btn dbtn-info" target="_blank"><span class="glyphicon glyphicon-edit" aria-hidden="true"></span> Improve Page</a>
                    <h1>Chat room</h1>
                </div>
                <div class="main">
                    <p>The Chat app demonstrates:</p>

<ul>
  <li>Using channels to implement a chat room with a <a href="http://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">publish-subscribe</a> model.</li>
  <li>Using Comet and <a href="/manual/websockets.html">Websockets</a></li>
</ul>

<p><a class="btn btn-success btn-sm" href="https://github.com/revel/examples/tree/master/chat" role="button"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Browse Source</a></p>

<p>Here are the contents of the app:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chat/app/
	chatroom	       # Chat room routines
		chatroom.go

	controllers
		app.go         # The welcome screen, allowing user to pick a technology
		refresh.go     # Handlers for the "Active Refresh" chat demo
		longpolling.go # Handlers for the "Long polling" ("Comet") chat demo
		websocket.go   # Handlers for the "Websocket" chat demo

	views
		...            # HTML and Javascript
</code></pre></div></div>

<h2 id="the-chat-room">The Chat Room</h2>

<p>First, let’s look at how the chat room is implemented, in
<a href="https://github.com/revel/examples/blob/master/chat/app/chatroom/chatroom.go"><code class="highlighter-rouge">app/chatroom/chatroom.go</code></a>.</p>

<p>The chat room runs as an independent go-routine, started on initialization:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">init</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">go</span><span class="x"> </span><span class="n">chatroom</span><span class="p">()</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>The <code class="highlighter-rouge">chatroom()</code> function simply selects on three channels and executes the
requested action.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="c">// Send a channel here to get room events back.  It will send the entire</span><span class="x">
	</span><span class="c">// archive initially, and then new messages as they come in.</span><span class="x">
	</span><span class="n">subscribe</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">make</span><span class="p">(</span><span class="k">chan</span><span class="x"> </span><span class="p">(</span><span class="k">chan</span><span class="o">&lt;-</span><span class="x"> </span><span class="n">Subscription</span><span class="p">),</span><span class="x"> </span><span class="m">10</span><span class="p">)</span><span class="x">
	</span><span class="c">// Send a channel here to unsubscribe.</span><span class="x">
	</span><span class="n">unsubscribe</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">make</span><span class="p">(</span><span class="k">chan</span><span class="x"> </span><span class="p">(</span><span class="o">&lt;-</span><span class="k">chan</span><span class="x"> </span><span class="n">Event</span><span class="p">),</span><span class="x"> </span><span class="m">10</span><span class="p">)</span><span class="x">
	</span><span class="c">// Send events here to publish them.</span><span class="x">
	</span><span class="n">publish</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">make</span><span class="p">(</span><span class="k">chan</span><span class="x"> </span><span class="n">Event</span><span class="p">,</span><span class="x"> </span><span class="m">10</span><span class="p">)</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">chatroom</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">archive</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">list</span><span class="o">.</span><span class="n">New</span><span class="p">()</span><span class="x">
	</span><span class="n">subscribers</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">list</span><span class="o">.</span><span class="n">New</span><span class="p">()</span><span class="x">

	</span><span class="k">for</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">select</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">case</span><span class="x"> </span><span class="n">ch</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">subscribe</span><span class="o">:</span><span class="x">
			</span><span class="c">// Add subscriber to list and send back subscriber channel + chat log.</span><span class="x">
		</span><span class="k">case</span><span class="x"> </span><span class="n">event</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">publish</span><span class="o">:</span><span class="x">
			</span><span class="c">// Send event to all subscribers and add to chat log.</span><span class="x">
		</span><span class="k">case</span><span class="x"> </span><span class="n">unsub</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">unsubscribe</span><span class="o">:</span><span class="x">
			</span><span class="c">// Remove subscriber from subscriber list.</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>Let’s see how each of those is implemented.</p>

<h3 id="subscribe">Subscribe</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span><span class="x"> </span><span class="n">ch</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">subscribe</span><span class="o">:</span><span class="x">
    </span><span class="k">var</span><span class="x"> </span><span class="n">events</span><span class="x"> </span><span class="p">[]</span><span class="n">Event</span><span class="x">
    </span><span class="k">for</span><span class="x"> </span><span class="n">e</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">archive</span><span class="o">.</span><span class="n">Front</span><span class="p">();</span><span class="x"> </span><span class="n">e</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="p">;</span><span class="x"> </span><span class="n">e</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">events</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">events</span><span class="p">,</span><span class="x"> </span><span class="n">e</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="p">(</span><span class="n">Event</span><span class="p">))</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="n">subscriber</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="nb">make</span><span class="p">(</span><span class="k">chan</span><span class="x"> </span><span class="n">Event</span><span class="p">,</span><span class="x"> </span><span class="m">10</span><span class="p">)</span><span class="x">
    </span><span class="n">subscribers</span><span class="o">.</span><span class="n">PushBack</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span><span class="x">
    </span><span class="n">ch</span><span class="x"> </span><span class="o">&lt;-</span><span class="x"> </span><span class="n">Subscription</span><span class="p">{</span><span class="n">events</span><span class="p">,</span><span class="x"> </span><span class="n">subscriber</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>A Subscription is created with two properties:</p>

<ul>
  <li>The chat log (archive)</li>
  <li>A channel that the subscriber can listen on to get new messages.</li>
</ul>

<p>The Subscription is then sent back over the channel that the subscriber
supplied.</p>

<h3 id="publish">Publish</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span><span class="x"> </span><span class="n">event</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">publish</span><span class="o">:</span><span class="x">
    </span><span class="k">for</span><span class="x"> </span><span class="n">ch</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">subscribers</span><span class="o">.</span><span class="n">Front</span><span class="p">();</span><span class="x"> </span><span class="n">ch</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="p">;</span><span class="x"> </span><span class="n">ch</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">ch</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">ch</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="p">(</span><span class="k">chan</span><span class="x"> </span><span class="n">Event</span><span class="p">)</span><span class="x"> </span><span class="o">&lt;-</span><span class="x"> </span><span class="n">event</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">archive</span><span class="o">.</span><span class="n">Len</span><span class="p">()</span><span class="x"> </span><span class="o">&gt;=</span><span class="x"> </span><span class="n">archiveSize</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">archive</span><span class="o">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">archive</span><span class="o">.</span><span class="n">Front</span><span class="p">())</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="n">archive</span><span class="o">.</span><span class="n">PushBack</span><span class="p">(</span><span class="n">event</span><span class="p">)</span><span class="x">
</span></code></pre></div></div>

<p>The published event is sent to the subscribers’ channels one by one.  Then the
event is added to the archive, which is trimmed if necessary.</p>

<h3 id="unsubscribe">Unsubscribe</h3>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span><span class="x"> </span><span class="n">unsub</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">unsubscribe</span><span class="o">:</span><span class="x">
    </span><span class="k">for</span><span class="x"> </span><span class="n">ch</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">subscribers</span><span class="o">.</span><span class="n">Front</span><span class="p">();</span><span class="x"> </span><span class="n">ch</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="p">;</span><span class="x"> </span><span class="n">ch</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">ch</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="n">ch</span><span class="o">.</span><span class="n">Value</span><span class="o">.</span><span class="p">(</span><span class="k">chan</span><span class="x"> </span><span class="n">Event</span><span class="p">)</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="n">unsub</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="n">subscribers</span><span class="o">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span><span class="x">
        </span><span class="p">}</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>The subscriber channel is removed from the list.</p>

<h2 id="handlers">Handlers</h2>

<p>Now that you know how the chat room works, we can look at how the handlers
expose that functionality using different techniques.</p>

<h3 id="active-refresh">Active Refresh</h3>

<p>The Active Refresh chat room javascript refreshes the page every five seconds to
get any new messages (see <a href="https://github.com/revel/examples/blob/master/chat/app/views/Refresh/Room.html"><code class="highlighter-rouge">Refresh/Room.html</code></a>):</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Scroll the messages panel to the end</span><span class="x">
</span><span class="k">var</span><span class="x"> </span><span class="n">scrollDown</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">function</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="err">$</span><span class="p">(</span><span class="err">'#</span><span class="n">thread</span><span class="err">'</span><span class="p">)</span><span class="o">.</span><span class="n">scrollTo</span><span class="p">(</span><span class="err">'</span><span class="n">max</span><span class="err">'</span><span class="p">);</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="c">// Reload the whole messages panel</span><span class="x">
</span><span class="k">var</span><span class="x"> </span><span class="n">refresh</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">function</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="err">$</span><span class="p">(</span><span class="err">'#</span><span class="n">thread</span><span class="err">'</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="err">'</span><span class="o">/</span><span class="n">refresh</span><span class="o">/</span><span class="n">room</span><span class="err">?</span><span class="n">user</span><span class="o">=</span><span class="p">{{</span><span class="o">.</span><span class="n">user</span><span class="p">}}</span><span class="x"> </span><span class="err">#</span><span class="n">thread</span><span class="x"> </span><span class="o">.</span><span class="n">message</span><span class="err">'</span><span class="p">,</span><span class="x"> </span><span class="n">function</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">scrollDown</span><span class="p">();</span><span class="x">
    </span><span class="p">})</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="c">// Call refresh every 5 seconds</span><span class="x">
</span><span class="n">setInterval</span><span class="p">(</span><span class="n">refresh</span><span class="p">,</span><span class="x"> </span><span class="m">5000</span><span class="p">);</span><span class="x">
</span></code></pre></div></div>

<p>This is the handler to serve the above in <a href="https://github.com/revel/examples/blob/master/chat/app/controllers/refresh.go"><code class="highlighter-rouge">app/controllers/refresh.go</code></a>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">c</span><span class="x"> </span><span class="n">Refresh</span><span class="p">)</span><span class="x"> </span><span class="n">Room</span><span class="p">(</span><span class="n">user</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="n">revel</span><span class="o">.</span><span class="n">Result</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">subscription</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">chatroom</span><span class="o">.</span><span class="n">Subscribe</span><span class="p">()</span><span class="x">
	</span><span class="k">defer</span><span class="x"> </span><span class="n">subscription</span><span class="o">.</span><span class="n">Cancel</span><span class="p">()</span><span class="x">
	</span><span class="n">events</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">subscription</span><span class="o">.</span><span class="n">Archive</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="n">i</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">events</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">User</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="n">user</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">User</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"you"</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">c</span><span class="o">.</span><span class="n">Render</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="x"> </span><span class="n">events</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>It subscribes to the chatroom and passes the archive to the template to be
rendered (after changing the user name to “you” as necessary).</p>

<h3 id="long-polling-comet">Long Polling (Comet)</h3>

<p>The Long Polling chat room (see <a href="https://github.com/revel/examples/blob/master/chat/app/views/LongPolling/Room.html"><code class="highlighter-rouge">LongPolling/Room.html</code></a>)
makes an ajax request that the server keeps open until a new message comes in. The javascript uses a
<code class="highlighter-rouge">lastReceived</code> timestamp to tell the server the last message it knows about.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">lastReceived</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">waitMessages</span> <span class="o">=</span> <span class="s1">'/longpolling/room/messages?lastReceived='</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">say</span> <span class="o">=</span> <span class="s1">'/longpolling/room/messages?user={{.user}}'</span><span class="p">;</span>

<span class="nx">$</span><span class="p">(</span><span class="s1">'#send'</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#message'</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#message'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">say</span><span class="p">,</span> <span class="p">{</span><span class="na">message</span><span class="p">:</span> <span class="nx">message</span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Retrieve new messages</span>
<span class="kd">var</span> <span class="nx">getMessages</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="na">url</span><span class="p">:</span> <span class="nx">waitMessages</span> <span class="o">+</span> <span class="nx">lastReceived</span><span class="p">,</span>
        <span class="na">success</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">events</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="nx">events</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">display</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                <span class="nx">lastReceived</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">Timestamp</span><span class="p">;</span>
            <span class="p">});</span>
            <span class="nx">getMessages</span><span class="p">();</span>
        <span class="p">},</span>
        <span class="na">dataType</span><span class="p">:</span> <span class="s1">'json'</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nx">getMessages</span><span class="p">();</span>
</code></pre></div></div>

<p>The handler for the above in <a href="https://github.com/revel/examples/blob/master/chat/app/controllers/longpolling.go"><code class="highlighter-rouge">app/controllers/longpolling.go</code></a></p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">c</span><span class="x"> </span><span class="n">LongPolling</span><span class="p">)</span><span class="x"> </span><span class="n">WaitMessages</span><span class="p">(</span><span class="n">lastReceived</span><span class="x"> </span><span class="kt">int</span><span class="p">)</span><span class="x"> </span><span class="n">revel</span><span class="o">.</span><span class="n">Result</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">subscription</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">chatroom</span><span class="o">.</span><span class="n">Subscribe</span><span class="p">()</span><span class="x">
	</span><span class="k">defer</span><span class="x"> </span><span class="n">subscription</span><span class="o">.</span><span class="n">Cancel</span><span class="p">()</span><span class="x">

	</span><span class="c">// See if anything is new in the archive.</span><span class="x">
	</span><span class="k">var</span><span class="x"> </span><span class="n">events</span><span class="x"> </span><span class="p">[]</span><span class="n">chatroom</span><span class="o">.</span><span class="n">Event</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">event</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">subscription</span><span class="o">.</span><span class="n">Archive</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">event</span><span class="o">.</span><span class="n">Timestamp</span><span class="x"> </span><span class="o">&gt;</span><span class="x"> </span><span class="n">lastReceived</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">events</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">events</span><span class="p">,</span><span class="x"> </span><span class="n">event</span><span class="p">)</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="c">// If we found one, grand.</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="x"> </span><span class="o">&gt;</span><span class="x"> </span><span class="m">0</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="n">c</span><span class="o">.</span><span class="n">RenderJSON</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="c">// Else, wait for something new.</span><span class="x">
	</span><span class="n">event</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">subscription</span><span class="o">.</span><span class="n">New</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">c</span><span class="o">.</span><span class="n">RenderJSON</span><span class="p">([]</span><span class="n">chatroom</span><span class="o">.</span><span class="n">Event</span><span class="p">{</span><span class="n">event</span><span class="p">})</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>In this implementation, it can simply block on the subscription channel, 
assuming it has already sent back everything in the archive.</p>

<h3 id="websocket">Websocket</h3>

<p>The Websocket chat room (see  <a href="https://github.com/revel/examples/blob/master/chat/app/views/WebSocket/Room.html#L51">WebSocket/Room.html</a>)
opens a <a href="/manual/websockets.html">websocket</a> connection as soon as the
user has loaded the page.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Create a socket</span>
<span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">'ws://127.0.0.1:9000/websocket/room/socket?user={{.user}}'</span><span class="p">);</span>

<span class="c1">// Message received on the socket</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">display</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">));</span>
<span class="p">}</span>

<span class="nx">$</span><span class="p">(</span><span class="s1">'#send'</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'#message'</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">'#message'</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>The first thing to do is to subscribe to new events, join the room, and send
down the archive.  Here is what <a href="https://github.com/revel/examples/blob/master/chat/app/controllers/websocket.go#L17">websocket.go</a> looks like:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">c</span><span class="x"> </span><span class="n">WebSocket</span><span class="p">)</span><span class="x"> </span><span class="n">RoomSocket</span><span class="p">(</span><span class="n">user</span><span class="x"> </span><span class="kt">string</span><span class="p">,</span><span class="x"> </span><span class="n">ws</span><span class="x"> </span><span class="n">revel</span><span class="o">.</span><span class="n">ServerWebSocket</span><span class="p">)</span><span class="x"> </span><span class="n">revel</span><span class="o">.</span><span class="n">Result</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="c">// Join the room.</span><span class="x">
	</span><span class="n">subscription</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">chatroom</span><span class="o">.</span><span class="n">Subscribe</span><span class="p">()</span><span class="x">
	</span><span class="k">defer</span><span class="x"> </span><span class="n">subscription</span><span class="o">.</span><span class="n">Cancel</span><span class="p">()</span><span class="x">

	</span><span class="n">chatroom</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="x">
	</span><span class="k">defer</span><span class="x"> </span><span class="n">chatroom</span><span class="o">.</span><span class="n">Leave</span><span class="p">(</span><span class="n">user</span><span class="p">)</span><span class="x">

	</span><span class="c">// Send down the archive.</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">event</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">subscription</span><span class="o">.</span><span class="n">Archive</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">ws</span><span class="o">.</span><span class="n">MessageSendJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">)</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="c">// They disconnected</span><span class="x">
			</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="o">....</span><span class="x">
</span></code></pre></div></div>

<p>Next, we have to listen for new events from the subscription.  However, the
websocket library only provides a blocking call to get a new frame.  To select
between them, we have to wrap it (<a href="https://github.com/revel/examples/blob/master/chat/app/controllers/websocket.go#L33">websocket.go</a>):</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// In order to select between websocket messages and subscription events, we</span><span class="x">
</span><span class="c">// need to stuff websocket events into a channel.</span><span class="x">
</span><span class="n">newMessages</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="nb">make</span><span class="p">(</span><span class="k">chan</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x">
</span><span class="k">go</span><span class="x"> </span><span class="k">func</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">var</span><span class="x"> </span><span class="n">msg</span><span class="x"> </span><span class="kt">string</span><span class="x">
    </span><span class="k">for</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ws</span><span class="o">.</span><span class="n">MessageReceiveJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">)</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="nb">close</span><span class="p">(</span><span class="n">newMessages</span><span class="p">)</span><span class="x">
            </span><span class="k">return</span><span class="x">
        </span><span class="p">}</span><span class="x">
        </span><span class="n">newMessages</span><span class="x"> </span><span class="o">&lt;-</span><span class="x"> </span><span class="n">msg</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}()</span><span class="x">
</span></code></pre></div></div>

<p>Now we can select for new websocket messages on the <code class="highlighter-rouge">newMessages</code> channel.</p>

<p>The last bit does exactly that – it waits for a new message from the websocket
(if the user has said something) or from the subscription (someone else in the
chat room has said something) and propagates the message to the other.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Now listen for new events from either the websocket or the chatroom.</span><span class="x">
</span><span class="k">for</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">select</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">case</span><span class="x"> </span><span class="n">event</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">subscription</span><span class="o">.</span><span class="n">New</span><span class="o">:</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="n">ws</span><span class="o">.</span><span class="n">MessageSendJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">)</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="c">// They disconnected.</span><span class="x">
            </span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
        </span><span class="p">}</span><span class="x">
    </span><span class="k">case</span><span class="x"> </span><span class="n">msg</span><span class="p">,</span><span class="x"> </span><span class="n">ok</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">newMessages</span><span class="o">:</span><span class="x">
        </span><span class="c">// If the channel is closed, they disconnected.</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="o">!</span><span class="n">ok</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
        </span><span class="p">}</span><span class="x">

        </span><span class="c">// Otherwise, say something.</span><span class="x">
        </span><span class="n">chatroom</span><span class="o">.</span><span class="n">Say</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="x"> </span><span class="n">msg</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">

</span></code></pre></div></div>

<blockquote>
  <p><a href="https://github.com/revel/examples/blob/master/chat/app/controllers/websocket.go#L48">websocket.go</a></p>
</blockquote>

<p>If we detect the websocket channel has closed, then we just return nil.</p>

                    


                    


                </div>
            </div>
        </div>
        
        <footer>
            <p>&copy; Revel Team 2017 - Revel is released under the <a href="https://github.com/revel/revel/blob/master/LICENSE">MIT License</a></p>
        </footer>
    </div>
</body>
</html>
